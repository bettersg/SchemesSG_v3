services:
  backend:
    build:
      context: .
      dockerfile: Dockerfile.firebase
    image: schemessg-backend
    volumes:
      - ./functions:/app/functions
      - ./start.sh:/start.sh
      - ./functions/.env:/app/functions/.env
      - ./firebase.json:/app/firebase.json
      - ./.firebaserc:/app/.firebaserc
      # Firebase credentials - cross-platform compatible
      - ./functions/creds.json:/root/.config/firebase/creds.json
      # exclude from mounting
      - /app/functions/venv
      - /app/functions/__pycache__
      - /app/functions/.pytest_cache
    environment:
      - OBJC_DISABLE_INITIALIZE_FORK_SAFETY=YES
      - no_proxy=*
      - GOOGLE_APPLICATION_CREDENTIALS=/root/.config/firebase/creds.json
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
      - ENVIRONMENT=local
      - FUNCTIONS_HOST=127.0.0.1
      - FUNCTIONS_PORT=5001
      # URL for scheme-processor service (Cloud Run in prod, local container in dev)
      - PROCESSOR_SERVICE_URL=http://scheme-processor:8081
      # Comment out to use cloud Firestore (schemessg-v3-dev) instead of emulator
      # Vector search requires cloud Firestore - emulator has limited support
      # - FIRESTORE_EMULATOR_HOST=localhost:8080
    # network_mode: host
    ports:
      - "5001:5001"
      - "4000:4000"
      - "4400:4400"
      - "8080:8080"
    depends_on:
      - scheme-processor

  # Cloud Run scheme processor service (scraping + LLM + Slack)
  scheme-processor:
    build:
      context: ./scheme-processor
      dockerfile: Dockerfile
    image: scheme-processor
    ports:
      - "8081:8081"
    volumes:
      # Hot reload for local development
      - ./scheme-processor:/app
    env_file:
      - ./functions/.env
    environment:
      - PYTHONUNBUFFERED=1
      - PORT=8081
    # Override CMD for hot reload in dev
    command: ["uv", "run", "uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8081", "--reload"]